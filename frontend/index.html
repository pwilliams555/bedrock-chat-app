<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with AWS Bedrock</title>

    <!-- Add Microsoft Authentication Library -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>

    <!-- Add library imports BEFORE our styles and scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.2.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    
    <!-- Add Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #343541;
            --text-primary: #ffffff;
            --text-secondary: #c5c5d2;
            --border-color: #404040;
            --accent-color: #10a37f;
            --error-color: #ef4444;
            --hover-color: #3f3f3f;
        }

        body {
            max-width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--bg-secondary);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            padding: 1rem;
            background-color: var(--bg-secondary);
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .chat-container {
            display: flex;
            flex: 1;
            position: relative;
            height: calc(100vh - 140px); /* Subtract header + controls height */
            overflow: hidden; /* Prevent container from scrolling */
        }

        .chat-history-panel {
            width: 260px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Contain the scrolling */
        }

        .chat-history-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        #chatList {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-tertiary);
            position: relative;
            overflow: visible; /* Allow content to be visible instead of hidden */
        }

        #chatbox {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto; /* Allow horizontal scrolling only when absolutely necessary */
            padding: 2rem;
            margin-bottom: 100px;  /* Space for input area */
            min-height: 0; /* Allow flex shrinking */
            word-wrap: break-word; /* Ensure long words wrap */
        }

        .input-area {
            position: fixed;
            bottom: 0;
            left: 260px;
            right: 0;
            padding: 1.5rem;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100; /* Ensure it stays above content */
            box-sizing: border-box; /* Include padding in width calculation */
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .image-preview-container {
            display: none;
            margin-bottom: 10px;
            position: relative;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .remove-image:hover {
            background-color: var(--hover-color);
            color: var(--text-primary);
        }

        .paste-hint {
            display: none;
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 4px;
        }

        .input-area:focus-within .paste-hint {
            display: block;
        }

        #userInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
            resize: none;
            min-height: 24px;
            max-height: 200px;
            line-height: 1.5;
        }

        /* Add styles for the button container */
        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: sticky;
            top: 0;
        }

        button {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0e906f;
        }

        .clear-button {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .clear-button:hover {
            background-color: var(--hover-color);
        }

        .header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .last-modified {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .control-group label {
            color: var(--text-secondary);
        }

        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            min-width: 200px;
            max-width: 300px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23c5c5d2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 8px auto;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        select option {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 8px;
        }

        #chatList::-webkit-scrollbar {
            width: 6px;
        }

        #chatList::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }

        #chatList::-webkit-scrollbar-track {
            background: transparent;
        }

        .message {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            line-height: 1.5;
            word-wrap: break-word; /* Ensure long words wrap */
            overflow-wrap: break-word; /* Additional browser support */
            max-width: 100%; /* Prevent messages from exceeding container */
        }

        .user-message {
            background-color: var(--bg-secondary);
        }

        .bot-message {
            background-color: var(--bg-primary);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .model-tag {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 2px 8px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            display: inline-block;
        }

        .chat-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            word-break: break-word;
        }

        .chat-item:hover {
            background-color: var(--hover-color);
        }

        .chat-item.active {
            background-color: var(--hover-color);
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .chat-item-preview {
            font-size: 13px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .chat-item-actions {
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-item:hover .chat-item-actions {
            opacity: 1;
        }

        .delete-chat-btn {
            background: none;
            border: none;
            color: var(--error-color);
            padding: 2px 6px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
            line-height: 1;
        }

        .delete-chat-btn:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }

        .test-models-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .test-models-btn:hover {
            background-color: var(--hover-color);
        }

        /* Code formatting styles */
        .formatted-content {
            line-height: 1.6;
            color: var(--text-primary);
            word-wrap: break-word; /* Ensure long words wrap */
            overflow-wrap: anywhere; /* More aggressive wrapping for better content fitting */
            max-width: 100%; /* Prevent content from exceeding container */
            overflow: visible; /* Allow content to be visible rather than clipped */
        }

        .formatted-content pre {
            background-color: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: anywhere;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
            max-width: 100%;
        }

        /* Code blocks inside pre elements */
        .formatted-content pre code {
            display: block;
            padding: 0;
            background: transparent;
            border: none;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: anywhere;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            color: var(--text-primary);
            max-width: 100%;
        }

        /* Inline code styling - higher specificity to override general code rules */
        .formatted-content p code,
        .formatted-content li code,
        .formatted-content h1 code,
        .formatted-content h2 code,
        .formatted-content h3 code,
        .formatted-content h4 code,
        .formatted-content td code,
        .formatted-content span code {
            background-color: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
            border: 1px solid var(--border-color);
            color: var(--text-primary) !important;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            white-space: pre-wrap !important; /* Allow wrapping instead of nowrap */
            word-break: break-word !important; /* Allow breaking long words */
            overflow-wrap: anywhere !important; /* More aggressive wrapping for long content */
            display: inline !important;
            vertical-align: baseline;
            margin: 0;
            max-width: 100%;
        }

        /* General code styling - only for cases not covered above */
        .formatted-content code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            color: var(--text-primary);
        }

        /* Override highlight.js theme to ensure visibility in dark mode */
        .formatted-content .hljs {
            background: transparent !important;
            color: var(--text-primary) !important;
        }

        /* Ensure all syntax elements are visible */
        .formatted-content .hljs-keyword,
        .formatted-content .hljs-selector-tag,
        .formatted-content .hljs-literal,
        .formatted-content .hljs-built_in { color: #569cd6 !important; }

        .formatted-content .hljs-string,
        .formatted-content .hljs-title,
        .formatted-content .hljs-section,
        .formatted-content .hljs-attribute,
        .formatted-content .hljs-variable,
        .formatted-content .hljs-template-variable,
        .formatted-content .hljs-symbol { color: #ce9178 !important; }

        .formatted-content .hljs-comment,
        .formatted-content .hljs-quote,
        .formatted-content .hljs-doctag { color: #6a9955 !important; }

        .formatted-content .hljs-number,
        .formatted-content .hljs-regexp,
        .formatted-content .hljs-literal { color: #b5cea8 !important; }

        .formatted-content .hljs-type,
        .formatted-content .hljs-class,
        .formatted-content .hljs-class .hljs-title { color: #4ec9b0 !important; }

        .formatted-content .hljs-function .hljs-title,
        .formatted-content .hljs-function { color: #dcdcaa !important; }

        .formatted-content .hljs-params { color: #9cdcfe !important; }

        .formatted-content .hljs-meta { color: #d4d4d4 !important; }

        .formatted-content .hljs-name,
        .formatted-content .hljs-tag { color: #569cd6 !important; }

        /* Fallback for any missed elements */
        .formatted-content .hljs * {
            color: inherit !important;
        }

        /* Ensure plaintext code blocks are readable */
        .formatted-content .language-plaintext {
            color: var(--text-primary) !important;
        }

        .formatted-content p {
            margin: 0.8em 0;
        }

        /* Update modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 50%;
            max-width: 500px;
            position: relative;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-body textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
            margin-top: 10px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-footer button {
            padding: 8px 16px;
        }

        .modal-footer button.cancel-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .model-tag.test-result {
            background-color: var(--bg-tertiary) !important;
            padding: 4px 8px;
            font-family: 'SFMono-Regular', Consolas, monospace;
            font-size: 12px;
        }

        .model-tag.test-result .model-name {
            color: var(--text-primary);
            font-weight: 600;
        }

        .model-tag.test-result .model-type {
            color: var(--text-secondary);
            font-size: 11px;
            margin-left: 4px;
        }

        /* Typing indicator styles */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin: 8px 0;
            width: fit-content;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing-dot 1.4s infinite;
            opacity: 0.3;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing-dot {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Improved list formatting */
        .formatted-content ol {
            margin: 1em 0;
            padding-left: 2em;
            list-style: decimal;
            color: var(--text-primary);
        }

        .formatted-content ol li {
            margin-bottom: 0.8em;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .formatted-content ol li::marker {
            color: var(--accent-color);
            font-weight: 600;
        }

        /* Handle nested lists */
        .formatted-content ol ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
            list-style: lower-alpha;
        }

        .formatted-content ol ol ol {
            list-style: lower-roman;
        }

        /* Ensure list items with paragraphs display properly */
        .formatted-content ol li p {
            margin: 0;
            display: inline;
        }

        /* Handle unordered lists */
        .formatted-content ul {
            margin: 1em 0;
            padding-left: 2em;
            list-style: disc;
        }

        .formatted-content ul li {
            margin-bottom: 0.5em;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .formatted-content ul li::marker {
            color: var(--accent-color);
        }

        .formatted-content ul ul {
            list-style: circle;
            margin: 0.3em 0;
        }

        .formatted-content ul ul ul {
            list-style: square;
        }

        /* Add styles for headers */
        .formatted-content h1, 
        .formatted-content h2, 
        .formatted-content h3, 
        .formatted-content h4 {
            margin: 1em 0 0.5em 0;
            color: var(--text-primary);
            font-weight: 600;
        }

        .formatted-content h1 { font-size: 1.5em; }
        .formatted-content h2 { font-size: 1.3em; }
        .formatted-content h3 { font-size: 1.2em; }
        .formatted-content h4 { font-size: 1.1em; }

        /* Add new auth-related styles */
        #loginContainer {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-secondary);
            text-align: center;
            display: none;
        }

        .auth-container {
            text-align: right;
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0 20px;
        }

        .auth-button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            margin: 0 auto;
        }

        .auth-button img {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            object-fit: contain;
            vertical-align: middle;
        }

        .auth-button:hover {
            background-color: #106ebe;
        }

        .sign-out-button {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .sign-out-button:hover {
            background-color: var(--hover-color);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .user-info {
            display: none;
            margin-right: 15px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Beta link styling */
        .beta-link {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 14px;
            margin-right: 20px;
            transition: opacity 0.2s;
        }

        .beta-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        /* Add new feedback-related styles */
        .new-chat-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .new-chat-btn:hover {
            background-color: var(--hover-color);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .feedback-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .feedback-modal-content {
            background-color: var(--bg-secondary);
            margin: 10% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
        }

        .feedback-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .feedback-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
            resize: vertical;
        }

        .feedback-form input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .feedback-list-panel {
            position: fixed;
            right: -420px;  /* Increased to ensure complete hiding */
            top: 0;
            width: 400px;
            height: 100%;
            background-color: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            transition: right 0.3s ease;
            z-index: 999;
            padding: 20px;
            overflow-y: auto;
        }

        .feedback-list-panel.open {
            right: 0;
        }

        .feedback-list-panel h2 {
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .feedback-item {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .feedback-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .feedback-item-content {
            color: var(--text-primary);
            line-height: 1.5;
        }

        .close-button {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .close-button:hover {
            color: var(--text-primary);
        }

        /* Add KB tag style */
        .kb-tag {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 2px 8px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            margin-left: 8px;
            border: 1px solid var(--border-color);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .kb-tag::before {
            content: "ðŸ“š";
            font-size: 12px;
        }

        /* Dev badge styling */
        .dev-badge {
            background-color: #ff6b6b;
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
            vertical-align: middle;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Copy button styles for code blocks */
        .code-block-container {
            position: relative;
            margin: 1rem 0;
        }

        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .code-block-container:hover .copy-button {
            opacity: 1;
        }

        .copy-button:hover {
            background-color: var(--hover-color);
            color: var(--text-primary);
        }

        .copy-button.copied {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .copy-button::before {
            content: "ðŸ“‹";
            font-size: 12px;
        }

        .copy-button.copied::before {
            content: "âœ“";
        }

        /* Ensure pre elements inside code containers maintain proper styling */
        .code-block-container pre {
            margin: 0;
            background-color: var(--bg-primary);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: anywhere;
            border: 1px solid var(--border-color);
            max-width: 100%;
        }

        /* Ensure all text content wraps properly and doesn't get cut off */
        .formatted-content * {
            word-wrap: break-word;
            overflow-wrap: anywhere;
            hyphens: auto;
            max-width: 100%;
        }

        /* Handle long URLs and links */
        .formatted-content a {
            word-break: break-all;
            overflow-wrap: break-word;
        }

        /* Ensure tables don't overflow */
        .formatted-content table {
            width: 100%;
            table-layout: fixed;
            overflow-wrap: break-word;
        }

        .formatted-content td,
        .formatted-content th {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Dev badge styling */
    </style>

    <script>
        // Detect if we're in development mode based on the URL path
        function isDevMode() {
            const path = window.location.pathname;
            return path.includes('/dev/') || path.includes('\\dev\\');
        }

        // Set up dev indicators
        function setupDevIndicators() {
            if (isDevMode()) {
                console.log('ðŸ”§ Running in DEVELOPMENT mode');
                
                // Update page title
                document.title = '[DEV] ' + document.title;
                
                // Show dev badge
                const devBadge = document.getElementById('devBadge');
                if (devBadge) {
                    devBadge.style.display = 'inline-block';
                }
                
                // Add a subtle visual indicator by slightly changing the header color
                const header = document.querySelector('.header');
                if (header) {
                    header.style.borderBottom = '2px solid #ff6b6b';
                }
            } else {
                console.log('ðŸš€ Running in PRODUCTION mode');
                
                // Show beta link in production
                const betaLink = document.getElementById('betaLink');
                if (betaLink) {
                    betaLink.style.display = 'inline-block';
                }
            }
        }

        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupDevIndicators();
        });

        // MSAL configuration
        const msalConfig = {
            auth: {
                clientId: "8f74eb82-1953-45a6-86e4-332549fda3f4",
                authority: "https://login.microsoftonline.com/edgeworthecon.com",
                redirectUri: "https://edgeworth-apps.s3.us-east-1.amazonaws.com/model-chat/index.html",
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false,
            }
        };

        // Global variables for image handling
        let pastedImage = null;
        let pastedImageData = null;

        // Global function for removing images
        function removeImage() {
            pastedImage = null;
            pastedImageData = null;
            const previewContainer = document.querySelector('.image-preview-container');
            const preview = document.querySelector('.image-preview');
            preview.src = '';
            previewContainer.style.display = 'none';
        }

        // Create the MSAL application object
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // Handle redirect response
        msalInstance.handleRedirectPromise()
            .then(response => {
                console.log('MSAL Redirect Response:', response);
                if (response) {
                    console.log('User authenticated, account:', response.account);
                    showUserInfo(response.account);
                    showMainContent();
                } else {
                    console.log('No redirect response, checking existing auth...');
                    checkAuth();
                }
            })
            .catch(error => {
                console.error("Error handling redirect:", error);
            });

        // Check if user is already logged in
        async function checkAuth() {
            console.log('Checking authentication...');
            const accounts = msalInstance.getAllAccounts();
            console.log('Found accounts:', accounts);
            if (accounts.length > 0) {
                // User is signed in
                console.log('User is signed in:', accounts[0]);
                showUserInfo(accounts[0]);
                showMainContent();
                return true;
            } else {
                // User is not signed in
                console.log('No signed in user found');
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                return false;
            }
        }

        // Handle sign-in
        async function signIn() {
            try {
                console.log('Initiating sign-in...');
                const loginRequest = {
                    scopes: ["openid", "profile", "email"]
                };
                console.log('Login request:', loginRequest);
                await msalInstance.loginRedirect(loginRequest);
            } catch (error) {
                console.error("Error during sign-in:", error);
                alert("Sign-in failed. Please try again.");
            }
        }

        // Handle sign-out
        function signOut() {
            const logoutRequest = {
                account: msalInstance.getAllAccounts()[0],
            };
            msalInstance.logoutRedirect(logoutRequest);
        }

        // Show user information
        function showUserInfo(account) {
            console.log('Showing user info for account:', account);
            const userInfo = document.getElementById('userInfo');
            userInfo.style.display = 'block';
            userInfo.innerHTML = `Signed in as: <strong>${account.username}</strong>`;
            document.getElementById('signOutButton').style.display = 'inline-flex';
        }

        // Show main content after authentication
        function showMainContent() {
            console.log('Showing main content');
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Load initial data after showing main content
            loadInitialData();
        }

        // New function to load initial data
        async function loadInitialData() {
            try {
                console.log('Loading initial data...');
                // Get current user
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    throw new Error("No user signed in");
                }
                const currentUser = accounts[0];

                // Load both KBs and chat list in parallel
                await Promise.all([
                    loadKnowledgeBases(),
                    loadChatList(currentUser.username)
                ]);
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        // Modify the loadKnowledgeBases function
        async function loadKnowledgeBases() {
            try {
                console.log('Fetching knowledge bases from:', KB_API_URL);
                const response = await fetch(KB_API_URL);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Received data:', data);
                
                const kbSelect = document.getElementById("kbSelect");
                // Clear existing options except "None"
                kbSelect.innerHTML = '<option value="none">None</option>';
                
                // Add knowledge bases from Bedrock, excluding sensitive ones
                if (data.knowledgeBases && Array.isArray(data.knowledgeBases)) {
                    console.log(`Adding ${data.knowledgeBases.length} knowledge bases to dropdown`);
                    const excludedKBs = [
                        'JEAYPOLYNK',
                        'MCM8NH7A08',
                        'BPMNPCCHTA'
                    ];
                    
                    // Debug log to see all KB IDs
                    console.log('Available KB IDs:', data.knowledgeBases.map(kb => kb.id));
                    console.log('Excluding KBs:', excludedKBs);
                    
                    data.knowledgeBases
                        .filter(kb => !excludedKBs.includes(kb.id))
                        .forEach(kb => {
                            const option = document.createElement("option");
                            option.value = kb.id;
                            option.textContent = kb.name;
                            if (kb.description) {
                                option.title = kb.description;
                            }
                            kbSelect.appendChild(option);
                        });
                } else {
                    console.warn('No knowledge bases found in response:', data);
                }
            } catch (error) {
                console.error('Error loading knowledge bases:', error);
                const kbSelect = document.getElementById("kbSelect");
                kbSelect.innerHTML = '<option value="none">None</option>';
                const errorOption = document.createElement("option");
                errorOption.value = "error";
                errorOption.textContent = "Error loading KBs";
                errorOption.disabled = true;
                kbSelect.appendChild(errorOption);
            }
        }

        // Modify the loadChatList function
        async function loadChatList(userEmail) {
            try {
                console.log('Loading chat list for user:', userEmail);
                const response = await fetch(`${API_URL}?action=list_chats&user_email=${encodeURIComponent(userEmail)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Received chat list:', data);
                console.log('Number of chats received:', data.chats ? data.chats.length : 0);
                console.log('Chat details:', data.chats);
                
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = '';
                
                if (data.chats && data.chats.length > 0) {
                    data.chats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        chatItem.className = `chat-item ${chat.chat_id === currentChatId ? 'active' : ''}`;
                        chatItem.setAttribute('data-chat-id', chat.chat_id); // Add missing data attribute
                        chatItem.onclick = () => loadChat(chat.chat_id);
                        
                        const time = new Date(chat.timestamp).toLocaleString();
                        
                        // Safely handle the last message display
                        const lastMessage = chat.last_message || 'No content';
                        
                        chatItem.innerHTML = `
                            <div class="chat-item-content">
                                <div class="chat-item-time">${time}</div>
                                <div class="chat-item-preview">${lastMessage}</div>
                            </div>
                            <div class="chat-item-actions">
                                <button class="delete-chat-btn" onclick="deleteChat(event, '${chat.chat_id}')">Ã—</button>
                            </div>
                        `;
                        
                        chatList.appendChild(chatItem);
                    });
                } else {
                    chatList.innerHTML = '<div class="chat-item">No previous chats</div>';
                }
            } catch (error) {
                console.error('Error loading chat list:', error);
                document.getElementById('chatList').innerHTML = 
                    '<div class="chat-item" style="color: red;">Error loading chat history</div>';
            }
        }

        // Modify the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, initializing...');
            
            // Check authentication first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return; // Don't proceed with initialization if not authenticated
            }
            
            // Set up event listeners
            const userInput = document.getElementById("userInput");
            userInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    if (e.shiftKey) {
                        // Allow default behavior for Shift+Enter (new line)
                        return;
                    } else {
                        e.preventDefault(); // Prevent default to avoid new line
                        sendMessage();
                    }
                }
            });

            // Update last modified date
            const lastModified = new Date(document.lastModified);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                timeZoneName: 'short'
            };
            document.getElementById('lastModified').textContent = 
                `Last modified: ${lastModified.toLocaleString('en-US', options)}`;

            // Initialize feedback list
            loadFeedbackList();

            // Add this after your DOMContentLoaded event listener
            document.getElementById('userInput').addEventListener('paste', async (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                
                for (const item of items) {
                    if (item.type.indexOf('image') === 0) {
                        e.preventDefault();
                        const blob = item.getAsFile();
                        pastedImage = blob;
                        
                        // Convert blob to base64
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            pastedImageData = event.target.result;
                            
                            // Show image preview
                            const previewContainer = document.querySelector('.image-preview-container');
                            const preview = document.querySelector('.image-preview');
                            preview.src = pastedImageData;
                            previewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(blob);
                        break;
                    }
                }
            });
        });

        // Add event listeners for auth buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('signInButton').addEventListener('click', signIn);
            document.getElementById('signOutButton').addEventListener('click', signOut);
        });

        // Initialize marked with enhanced options
        marked.setOptions({
            gfm: true,  // GitHub Flavored Markdown
            breaks: true,  // Add <br> on single line breaks
            headerIds: false,  // Don't add IDs to headers
            mangle: false,
            smartLists: true,
            smartypants: true
        });

        // Set up custom renderer for code blocks
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            // Handle code blocks with proper language highlighting
            let validLanguage = 'plaintext';
            let highlighted = code;
            
            // Try to highlight if language is specified and supported
            if (language) {
                try {
                    if (hljs.getLanguage(language)) {
                        validLanguage = language;
                        highlighted = hljs.highlight(code, { language: validLanguage }).value;
                    } else {
                        // For unsupported languages like SAS, use plaintext but preserve formatting
                        highlighted = hljs.highlight(code, { language: 'plaintext' }).value;
                    }
                } catch (error) {
                    console.warn('Highlighting failed for language:', language, error);
                    // Fallback to escaped HTML
                    highlighted = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                }
            } else {
                // No language specified, try auto-detection
                try {
                    const result = hljs.highlightAuto(code);
                    highlighted = result.value;
                    validLanguage = result.language || 'plaintext';
                } catch (error) {
                    console.warn('Auto-highlighting failed:', error);
                    highlighted = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                }
            }
            
            // Generate unique ID for this code block
            const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
            
            return `
                <div class="code-block-container">
                    <button class="copy-button" onclick="copyCode('${codeId}')" title="Copy code">Copy</button>
                    <pre><code id="${codeId}" class="hljs language-${validLanguage}">${highlighted}</code></pre>
                </div>`;
        };
        marked.setOptions({ renderer: renderer });

        const API_URL = "https://6uj8oni86a.execute-api.us-east-1.amazonaws.com/prod/chat";
        const KB_API_URL = "https://6uj8oni86a.execute-api.us-east-1.amazonaws.com/prod/knowledge-bases";

        // Add chat management
        let currentChatId = null;

        function formatResponse(response) {
            try {
                // Enhanced debug logging to understand truncation issue
                console.log('Raw response:', response);
                console.log('Raw response length:', response ? response.length : 'N/A');
                console.log('Raw response type:', typeof response);
                
                // Check if the response is an image message object
                if (response && typeof response === 'object' && response.type === 'image_message') {
                    let content = '';
                    if (response.image) {
                        content += `<img src="${response.image}" style="max-width: 400px; max-height: 400px; border-radius: 8px; margin: 10px 0;">`;
                    }
                    if (response.text) {
                        content += `<p>${response.text}</p>`;
                    }
                    return content;
                }

                // Ensure we have a string for text processing
                let processedResponse = String(response);
                console.log('String conversion length:', processedResponse.length);
                
                // Count lines in original response
                const originalLines = processedResponse.split('\n').length;
                console.log('Original line count:', originalLines);
                
                // Simple pre-processing to handle common markdown issues
                processedResponse = processedResponse
                    .replace(/\r\n/g, '\n')
                    // Unescape any escaped backticks
                    .replace(/\\`/g, '`')
                    // Fix escaped quotes that might interfere with code blocks
                    .replace(/\\"/g, '"')
                    .replace(/\\'/g, "'")
                    // Remove common AI response prefixes
                    .replace(/^\s*Certainly!.*?:\s*$/m, '')
                    .replace(/^\s*Here's\s+.*?:\s*$/m, '')
                    .trim();

                console.log('Processed response before marked:', processedResponse);
                console.log('Processed response length:', processedResponse.length);
                
                // Count lines after processing
                const processedLines = processedResponse.split('\n').length;
                console.log('Processed line count:', processedLines);

                // Use marked to parse markdown - this handles code blocks properly
                let html = marked.parse(processedResponse);
                
                console.log('HTML after marked:', html);
                console.log('HTML length:', html.length);
                
                // Count lines in final HTML
                const htmlLines = html.split('\n').length;
                console.log('Final HTML line count:', htmlLines);

                // Minimal post-processing - only clean up empty paragraphs
                html = html
                    // Clean up any empty paragraphs
                    .replace(/<p>\s*<\/p>/g, '');

                console.log('Final HTML after cleanup:', html.length);
                return html;
            } catch (error) {
                console.error('Error in formatResponse:', error);
                // Fallback to basic formatting
                return String(response)
                    .replace(/\*\*/g, '')  // Remove bold markers
                    .replace(/##?#?\s*/g, '')  // Remove header markers
                    .replace(/\n/g, '<br>');  // Convert newlines to breaks
            }
        }

        function formatCodeBlock(response) {
            try {
                // Remove markdown code markers
                let code = response.replace(/```\w*\n?/g, '').trim();
                
                // If the code doesn't start with a common programming construct,
                // check if it contains one and split accordingly
                if (!code.startsWith('def ') && !code.startsWith('class ') && !code.startsWith('import ')) {
                    const matches = code.match(/(.*?)((?:def|class|import)\s+.*)/s);
                    if (matches) {
                        return `
                            <p>${matches[1].trim()}</p>
                            <pre><code class="language-python">${matches[2].trim()}</code></pre>
                        `;
                    }
                }
                
                return `<pre><code class="language-python">${code}</code></pre>`;
            } catch (error) {
                console.error('Error in formatCodeBlock:', error);
                return `<pre><code>${response}</code></pre>`;
            }
        }

        function startNewChat() {
            console.log('Starting new chat');
            currentChatId = null;
            document.getElementById("chatbox").innerHTML = '';
            
            // Reset KB dropdown to "None"
            document.getElementById("kbSelect").value = "none";
            
            // Update chat list to show no active chat
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Get current user and refresh chat list
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                loadChatList(accounts[0].username);
            } else {
                console.error('No user signed in when trying to start new chat');
            }
        }

        function showTypingIndicator() {
            const chatbox = document.getElementById("chatbox");
            chatbox.innerHTML += `
                <div class="message bot-message" id="typing-message">
                    <div class="message-header">
                        <b>AI:</b>
                    </div>
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>`;
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingMessage = document.getElementById("typing-message");
            if (typingMessage) {
                typingMessage.remove();
            }
        }

        async function loadChat(chatId) {
            try {
                console.log('Loading chat:', chatId);
                currentChatId = chatId;
                
                // Reset KB dropdown to "None"
                document.getElementById("kbSelect").value = "none";
                
                // Get current user
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    throw new Error("No user signed in");
                }
                const currentUser = accounts[0];
                
                // Update active state in chat list
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.toggle('active', item.getAttribute('data-chat-id') === chatId);
                });

                // Clear current chat display
                document.getElementById("chatbox").innerHTML = '';
                
                // Load chat history with user email
                await loadChatHistory(chatId, currentUser.username);
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        async function loadChatHistory(chatId, userEmail) {
            if (!chatId) {
                console.log('No chat ID provided, skipping history load');
                return;
            }

            try {
                console.log('Loading chat history for:', chatId);
                const response = await fetch(`${API_URL}?chat_id=${chatId}&user_email=${encodeURIComponent(userEmail)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Received chat history:', data);

                const chatbox = document.getElementById("chatbox");
                // Clear existing messages before adding new ones
                chatbox.innerHTML = '';

                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        const formattedContent = formatResponse(msg.content);
                        const messageHtml = `
                            <div class="message ${msg.role === 'user' ? 'user-message' : 'bot-message'}">
                                <div class="message-header">
                                    <b>${msg.role === 'user' ? 'You' : 'AI'}:</b>
                                    ${msg.role === 'assistant' ? `<span class="model-tag">${msg.model || 'Unknown Model'}</span>` : ''}
                                    ${msg.kb_id ? `<span class="kb-tag">${getKBName(msg.kb_id)}</span>` : ''}
                                    <span class="timestamp">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                                </div>
                                <div class="formatted-content">
                                    ${formattedContent}
                                </div>
                            </div>`;
                        chatbox.innerHTML += messageHtml;
                    });
                    chatbox.scrollTop = chatbox.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                throw error;
            }
        }

        async function sendMessage() {
            const userInput = document.getElementById("userInput");
            const sendButton = document.querySelector('.input-area button');
            const spinner = document.getElementById('spinner');

            if (sendButton.disabled || (!userInput.value.trim() && !pastedImage)) return;

            try {
                // Get current user
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    throw new Error("No user signed in");
                }
                const currentUser = accounts[0];

                const message = userInput.value.trim();
                userInput.value = ''; // Clear input early

                sendButton.disabled = true;
                sendButton.classList.add('loading');
                spinner.style.display = 'inline-block';
                userInput.disabled = true;

                const chatbox = document.getElementById("chatbox");
                
                // Create message content with image if present
                let messageContent = '';
                if (pastedImageData) {
                    messageContent += `<img src="${pastedImageData}" style="max-width: 400px; max-height: 400px; border-radius: 8px; margin: 10px 0;">`;
                }
                if (message) {
                    messageContent += `<p>${message}</p>`;
                }

                // Add user message immediately for better UX
                chatbox.innerHTML += `
                    <div class="message user-message">
                        <div class="message-header">
                            <b>You:</b>
                            <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                        </div>
                        <div class="formatted-content">
                            ${messageContent}
                        </div>
                    </div>`;
                chatbox.scrollTop = chatbox.scrollHeight;

                // Show typing indicator
                showTypingIndicator();

                const modelSelect = document.getElementById("modelSelect");
                const kbSelect = document.getElementById("kbSelect");

                const payload = {
                    message: message,
                    model: modelSelect.value,
                    chat_id: currentChatId,
                    user_email: currentUser.username,
                    user_name: currentUser.name || currentUser.username
                };

                if (kbSelect.value !== "none") {
                    payload.knowledgeBaseId = kbSelect.value;
                }

                // Add image data if present
                if (pastedImageData) {
                    payload.image = pastedImageData;
                }

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Remove typing indicator before showing response
                removeTypingIndicator();

                // Clear any pasted image
                removeImage();

                // Update current chat ID if this is a new chat
                const isNewChat = !currentChatId;
                if (isNewChat) {
                    currentChatId = data.chat_id;
                }

                if (isNewChat) {
                    // For new chats, load the complete chat history
                    await loadChatHistory(currentChatId, currentUser.username);
                } else {
                    // For existing chats, just append the AI response
                    const modelSelect = document.getElementById("modelSelect");
                    const kbSelect = document.getElementById("kbSelect");
                    const kbId = kbSelect.value;
                    
                    const aiMessageHtml = `
                        <div class="message bot-message">
                            <div class="message-header">
                                <b>AI:</b>
                                <span class="model-tag">${modelSelect.value}</span>
                                ${kbId !== "none" ? `<span class="kb-tag">${getKBName(kbId)}</span>` : ''}
                                <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                            </div>
                            <div class="formatted-content">
                                ${formatResponse(data.response)}
                            </div>
                        </div>`;
                    chatbox.innerHTML += aiMessageHtml;
                    chatbox.scrollTop = chatbox.scrollHeight;
                }
                
                // Refresh the chat list
                await loadChatList(currentUser.username);

            } catch (error) {
                console.error('Error sending message:', error);
                removeTypingIndicator();
                document.getElementById("chatbox").innerHTML += `
                    <div class="message bot-message" style="color: var(--error-color)">
                        <strong>Error:</strong> Failed to send message. Details: ${error.message}
                    </div>`;
            } finally {
                sendButton.disabled = false;
                sendButton.classList.remove('loading');
                spinner.style.display = 'none';
                userInput.disabled = false;
                userInput.focus();
            }
        }

        async function deleteChat(event, chatId) {
            // Prevent the click from triggering chat load
            event.stopPropagation();

            try {
                // Get current user
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    throw new Error("No user signed in");
                }
                const currentUser = accounts[0];

                const response = await fetch(`${API_URL}?chat_id=${chatId}&user_email=${encodeURIComponent(currentUser.username)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    // If we're deleting the current chat, clear it
                    if (chatId === currentChatId) {
                        currentChatId = null;
                        document.getElementById("chatbox").innerHTML = '';
                    }
                    // Refresh the chat list
                    await loadChatList(currentUser.username);
                } else {
                    throw new Error(data.message || 'Failed to delete chat');
                }
            } catch (error) {
                console.error('Error deleting chat:', error);
                alert('Failed to delete chat: ' + error.message);
            }
        }

        function showTestModal() {
            document.getElementById('testModal').style.display = 'block';
        }

        function closeTestModal() {
            document.getElementById('testModal').style.display = 'none';
        }

        // Add this function to format model names
        function formatModelName(modelId) {
            if (modelId.includes('claude-3-7')) {
                return {
                    name: 'Claude 3.7',
                    type: 'Sonnet'
                };
            } else if (modelId.includes('claude-3-5')) {
                return {
                    name: 'Claude 3.5',
                    type: 'Sonnet'
                };
            } else if (modelId.includes('nova-micro')) {
                return {
                    name: 'Nova',
                    type: 'Micro'
                };
            } else if (modelId.includes('nova-lite')) {
                return {
                    name: 'Nova',
                    type: 'Lite'
                };
            } else if (modelId.includes('nova-pro')) {
                return {
                    name: 'Nova',
                    type: 'Pro'
                };
            }
            return {
                name: modelId,
                type: ''
            };
        }

        // Update the runTest function to use the new model name formatting
        async function runTest() {
            const testPrompt = document.getElementById('testPrompt').value.trim();
            if (!testPrompt) return;
            
            closeTestModal();
            const chatbox = document.getElementById("chatbox");
            const kbSelect = document.getElementById("kbSelect");
            const kbId = kbSelect.value;
            const kbName = kbSelect.options[kbSelect.selectedIndex].text;
            
            // Get current user
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) {
                throw new Error("No user signed in");
            }
            const currentUser = accounts[0];
            
            chatbox.innerHTML = `
                <div class="message user-message">
                    <div class="message-header">
                        <b>Test Prompt:</b>
                        ${kbId !== "none" ? `<span class="kb-tag">KB: ${kbName}</span>` : ''}
                    </div>
                    ${testPrompt}
                </div>`;
            
            const models = [
                "arn:aws:bedrock:us-east-1:401390491831:inference-profile/us.anthropic.claude-3-7-sonnet-20250219-v1:0",
                "arn:aws:bedrock:us-east-1:401390491831:inference-profile/us.anthropic.claude-3-5-sonnet-20241022-v2:0",
                "amazon.nova-micro-v1:0",
                "amazon.nova-lite-v1:0",
                "amazon.nova-pro-v1:0"
            ];

            const promises = models.map(async (model) => {
                try {
                    const payload = { 
                        "message": testPrompt,
                        "model": model,
                        "user_email": currentUser.username,
                        "user_name": currentUser.name || currentUser.username,
                        "test_mode": true
                    };

                    if (kbId !== "none") {
                        payload.knowledgeBaseId = kbId;
                    }

                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    return {
                        model: model,
                        response: data.response,
                        success: true
                    };
                } catch (error) {
                    return {
                        model: model,
                        response: "Failed to get response: " + error.message,
                        success: false
                    };
                }
            });

            const results = await Promise.all(promises);
            results.forEach(result => {
                const modelInfo = formatModelName(result.model);
                chatbox.innerHTML += `
                    <div class="message bot-message test-result">
                        <div class="message-header">
                            <b>Bot:</b>
                            <span class="model-tag test-result">
                                <span class="model-name">${modelInfo.name}</span>
                                <span class="model-type">${modelInfo.type}</span>
                            </span>
                            ${kbId !== "none" ? `<span class="kb-tag">KB: ${kbName}</span>` : ''}
                        </div>
                        <div class="formatted-content">
                            ${formatResponse(result.response)}
                        </div>
                    </div>`;
            });

            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // Add new feedback-related JavaScript functions
        function showFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'block';
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
        }

        function toggleFeedbackList() {
            const panel = document.getElementById('feedbackListPanel');
            panel.classList.toggle('open');
        }

        async function submitFeedback() {
            const name = document.getElementById('feedbackName').value.trim();
            const message = document.getElementById('feedbackMessage').value.trim();
            
            if (!message) {
                alert('Please enter your feedback message');
                return;
            }

            try {
                const accounts = msalInstance.getAllAccounts();
                const userEmail = accounts.length > 0 ? accounts[0].username : 'anonymous';
                
                const response = await fetch(`${API_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'submit_feedback',
                        user_email: userEmail,
                        name: name || 'Anonymous',
                        message: message,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) throw new Error('Failed to submit feedback');

                alert('Thank you for your feedback!');
                closeFeedbackModal();
                document.getElementById('feedbackForm').reset();
                loadFeedbackList();
            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert('Failed to submit feedback. Please try again.');
            }
        }

        async function loadFeedbackList() {
            try {
                const response = await fetch(`${API_URL}?action=list_feedback`);
                if (!response.ok) throw new Error('Failed to load feedback');
                
                const data = await response.json();
                const feedbackList = document.getElementById('feedbackList');
                feedbackList.innerHTML = '';

                data.feedback.forEach(item => {
                    const date = new Date(item.timestamp).toLocaleString();
                    feedbackList.innerHTML += `
                        <div class="feedback-item">
                            <div class="feedback-item-header">
                                <span>${item.name}</span>
                                <span>${date}</span>
                            </div>
                            <div class="feedback-item-content">${item.message}</div>
                        </div>`;
                });
            } catch (error) {
                console.error('Error loading feedback:', error);
            }
        }

        // Add function to get KB name from ID
        function getKBName(kbId) {
            const kbSelect = document.getElementById("kbSelect");
            const option = Array.from(kbSelect.options).find(opt => opt.value === kbId);
            return option ? option.text : kbId;
        }

        // Manual refresh function for chat list
        async function refreshChatList() {
            try {
                console.log('Manually refreshing chat list...');
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    await loadChatList(accounts[0].username);
                    console.log('Chat list refreshed successfully');
                } else {
                    console.error('No user signed in for refresh');
                }
            } catch (error) {
                console.error('Error refreshing chat list:', error);
            }
        }

        // Clear current chat function
        function clearChat() {
            document.getElementById("chatbox").innerHTML = '';
            console.log('Chat cleared');
        }

        // Copy code block to clipboard
        async function copyCode(codeId) {
            try {
                const codeElement = document.getElementById(codeId);
                if (!codeElement) {
                    console.error('Code element not found:', codeId);
                    return;
                }

                // Get the text content (this preserves the original code without HTML)
                const codeText = codeElement.textContent || codeElement.innerText;
                
                // Use the modern clipboard API
                await navigator.clipboard.writeText(codeText);
                
                // Visual feedback
                const button = codeElement.parentElement.querySelector('.copy-button');
                if (button) {
                    const originalText = button.textContent;
                    button.classList.add('copied');
                    button.textContent = 'Copied!';
                    
                    setTimeout(() => {
                        button.classList.remove('copied');
                        button.textContent = 'Copy';
                    }, 2000);
                }
            } catch (error) {
                console.error('Failed to copy code:', error);
                
                // Fallback for older browsers
                try {
                    const codeElement = document.getElementById(codeId);
                    const textArea = document.createElement('textarea');
                    textArea.value = codeElement.textContent || codeElement.innerText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    // Visual feedback for fallback
                    const button = codeElement.parentElement.querySelector('.copy-button');
                    if (button) {
                        const originalText = button.textContent;
                        button.classList.add('copied');
                        button.textContent = 'Copied!';
                        
                        setTimeout(() => {
                            button.classList.remove('copied');
                            button.textContent = 'Copy';
                        }, 2000);
                    }
                } catch (fallbackError) {
                    console.error('Fallback copy also failed:', fallbackError);
                    alert('Failed to copy code to clipboard');
                }
            }
        }
    </script>
</head>
<body>
    <!-- Add login container -->
    <div id="loginContainer">
        <h2>Chat with AWS Bedrock</h2>
        <p>Please sign in to access the chat system</p>
        <button id="signInButton" class="auth-button">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/Microsoft_logo.svg/512px-Microsoft_logo.svg.png" alt="Microsoft logo" width="20" height="20">
            Sign in with Microsoft
        </button>
    </div>

    <!-- Wrap existing content in mainContent div -->
    <div id="mainContent">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Chat with AWS Bedrock <span class="dev-badge" id="devBadge" style="display: none;">DEV</span></h2>
                <div class="auth-container">
                    <a href="dev/index.html" id="betaLink" class="beta-link" style="display: none;">Try Beta Version â†’</a>
                    <div class="user-info" id="userInfo"></div>
                    <button id="signOutButton" class="sign-out-button" style="display: none;">
                        Sign Out
                    </button>
                </div>
            </div>
            <div id="lastModified" class="last-modified"></div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="modelSelect">Model:</label>
                <select id="modelSelect">
                    <option value="arn:aws:bedrock:us-east-1:401390491831:inference-profile/us.anthropic.claude-3-7-sonnet-20250219-v1:0">Claude 3.7 Sonnet</option>
                    <option value="arn:aws:bedrock:us-east-1:401390491831:inference-profile/us.anthropic.claude-3-5-sonnet-20241022-v2:0">Claude 3.5 Sonnet v2</option>
                    <option value="amazon.nova-micro-v1:0">Nova Micro</option>
                    <option value="amazon.nova-lite-v1:0">Nova Lite</option>
                    <option value="amazon.nova-pro-v1:0">Nova Pro</option>
                </select>
                <button onclick="showTestModal()" class="test-models-btn">Test All Models</button>
                <button onclick="startNewChat()" class="new-chat-btn">New Chat</button>
            </div>
            
            <div class="control-group">
                <label for="kbSelect">Knowledge Base:</label>
                <select id="kbSelect">
                    <option value="none">None</option>
                </select>
            </div>
            
            <div class="control-group" style="margin-left: auto;">
                <button onclick="toggleFeedbackList()" class="new-chat-btn" title="View Feedback">View Feedback</button>
                <button onclick="showFeedbackModal()" class="new-chat-btn" title="Give Feedback">Give Feedback</button>
            </div>
        </div>

        <div class="chat-container">
                    <div class="chat-history-panel">
            <div class="chat-history-header">
                Chat History
                <button onclick="refreshChatList()" style="float: right; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 16px;" title="Refresh Chat List">â†»</button>
            </div>
            <div id="chatList"></div>
        </div>
            <div class="chat-main">
                <div id="chatbox"></div>
                <div class="input-area">
                    <div class="image-preview-container">
                        <img class="image-preview" />
                        <button class="remove-image" onclick="removeImage()">Ã—</button>
                    </div>
                    <div class="input-container">
                        <textarea id="userInput" placeholder="Type your message here... (Ctrl+V to paste an image)" rows="1"></textarea>
                        <div class="input-buttons">
                            <button onclick="sendMessage()">Send</button>
                            <button onclick="clearChat()" class="clear-button">Clear</button>
                            <div id="spinner" class="spinner"></div>
                        </div>
                    </div>
                    <div class="paste-hint">Tip: You can paste images directly into the message box</div>
                </div>
            </div>
        </div>

        <!-- Replace the existing test modal HTML with this -->
        <div id="testModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Test All Models</h3>
                </div>
                <div class="modal-body">
                    <label for="testPrompt">Enter your test prompt:</label>
                    <textarea id="testPrompt" placeholder="What would you like to ask all models?">What is 2+2? Answer in one sentence.</textarea>
                </div>
                <div class="modal-footer">
                    <button onclick="runTest()" class="primary-btn">Run Test</button>
                    <button onclick="closeTestModal()" class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update feedback list panel -->
    <div id="feedbackListPanel" class="feedback-list-panel">
        <h2>
            User Feedback
            <span class="close-button" onclick="toggleFeedbackList()">&times;</span>
        </h2>
        <div id="feedbackList"></div>
    </div>

    <!-- Add back the feedback modal -->
    <div id="feedbackModal" class="feedback-modal">
        <div class="feedback-modal-content">
            <span class="close-button" onclick="closeFeedbackModal()">&times;</span>
            <h2>Share Your Feedback</h2>
            <form id="feedbackForm" class="feedback-form" onsubmit="event.preventDefault(); submitFeedback();">
                <input type="text" id="feedbackName" placeholder="Your name (optional)">
                <textarea id="feedbackMessage" placeholder="What's on your mind? Share your thoughts, suggestions, or report issues..."></textarea>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeFeedbackModal()">Cancel</button>
                    <button type="submit" style="background-color: var(--accent-color);">Submit Feedback</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>